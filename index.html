<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust Wasm P2P Messaging (Multi-Peer)</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 80px;
            margin-bottom: 10px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        #chat-log {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }

        .my-message {
            color: blue;
            text-align: right;
            background: #e6f2ff;
        }

        .peer-message {
            color: green;
            background: #e6ffe6;
        }

        .system-message {
            color: #666;
            font-style: italic;
            font-size: 0.9em;
            text-align: center;
        }

        .section {
            margin-bottom: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .peer-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .peer-status {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 10px;
            background: #eee;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select {
            padding: 5px;
            margin-bottom: 10px;
            min-width: 150px;
        }
    </style>
</head>

<body>
    <h1>Rust Wasm P2P Messaging (Multi-Peer)</h1>

    <div class="section">
        <h2>1. Manage Peers</h2>
        <p>Add peers by giving them a unique ID (e.g., "Alice", "Bob").</p>
        <div>
            <input type="text" id="new-peer-id" placeholder="Peer ID (e.g. Bob)">
            <button id="btn-add-peer">Add Peer</button>
        </div>
        <div id="peers-list" style="margin-top: 10px; border: 1px solid #ddd; padding: 10px; min-height: 50px;">
            <!-- Peer items will go here -->
            <div style="color: #999;">No peers added yet.</div>
        </div>
    </div>

    <div class="section">
        <h2>2. Connection Setup</h2>
        <p>Select a peer to manage connection.</p>

        <label for="conn-peer-select">Target Peer:</label>
        <select id="conn-peer-select">
            <option value="">-- Select Peer --</option>
        </select>

        <div id="connection-controls" style="margin-top: 10px;">
            <button id="btn-create-offer">Create Offer (Host)</button>
            <button id="btn-join">Join (Create Answer)</button>
            <button id="btn-receive-answer">Receive Answer (Host)</button>

            <h3>SDP Exchange</h3>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Local SDP (Copy this)</label>
                    <textarea id="local-sdp" readonly placeholder="Generated SDP..."></textarea>
                </div>
                <div style="flex: 1;">
                    <label>Remote SDP (Paste here)</label>
                    <textarea id="remote-sdp" placeholder="Paste remote SDP..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>3. Trickle ICE Candidates</h2>
        <p>Select peer to exchange candidates.</p>
        <label for="ice-peer-select">Target Peer:</label>
        <select id="ice-peer-select">
            <option value="">-- Select Peer --</option>
        </select>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
                <label>Local Candidates (Copy array)</label>
                <textarea id="local-candidates" readonly>[ ]</textarea>
            </div>
            <div style="flex: 1;">
                <label>Remote Candidates (Paste array)</label>
                <textarea id="remote-candidates" placeholder="Paste remote candidates JSON array..."></textarea>
                <button id="btn-add-candidates">Add Candidates</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>4. Chat</h2>
        <div id="chat-log"></div>

        <div style="display: flex; gap: 10px;">
            <select id="chat-peer-select" style="margin-bottom: 0;">
                <option value="broadcast">Broadcast (All)</option>
            </select>
            <input type="text" id="msg-input" placeholder="Type a message..." style="flex: 1;">
            <button id="btn-send">Send</button>
        </div>
    </div>

    <script type="module">
        import init, { PeerManager } from './pkg/p2p_messaging.js';

        let manager = null;
        let peers = new Set(); // Track peer IDs
        let localCandidatesMap = new Map(); // peerId -> [candidates]

        async function run() {
            await init();
            manager = new PeerManager();
            setupCallbacks();
            setupUI();
            logSystem("Ready. Add a peer to start.");
        }

        function setupCallbacks() {
            manager.set_on_peer_message((peerId, msg) => {
                logMessage(peerId, msg, "peer-message");
            });

            manager.set_on_peer_ice_candidate((peerId, candidateJson) => {
                const candidate = JSON.parse(candidateJson);
                if (!localCandidatesMap.has(peerId)) {
                    localCandidatesMap.set(peerId, []);
                }
                localCandidatesMap.get(peerId).push(candidate);

                // Update UI if this peer is selected
                const currentIcePeer = document.getElementById('ice-peer-select').value;
                if (currentIcePeer === peerId) {
                    updateLocalCandidatesUI(peerId);
                }
            });

            manager.set_on_peer_connection_state_change((peerId, state) => {
                console.log(`[${peerId}] Connection state: ${state}`);
                updatePeerStatus(peerId, state);
            });
        }

        function setupUI() {
            // Add Peer
            document.getElementById('btn-add-peer').onclick = () => {
                const idInput = document.getElementById('new-peer-id');
                const id = idInput.value.trim();
                if (!id) return alert("Enter a Peer ID");
                if (peers.has(id)) return alert("Peer ID already exists");

                try {
                    manager.add_peer(id);
                    peers.add(id);
                    localCandidatesMap.set(id, []);

                    addPeerToUI(id);
                    updateSelects();
                    idInput.value = "";
                    logSystem(`Added peer: ${id}`);
                } catch (e) {
                    console.error(e);
                    alert("Error adding peer: " + e);
                }
            };

            // Create Offer
            document.getElementById('btn-create-offer').onclick = async () => {
                const peerId = document.getElementById('conn-peer-select').value;
                if (!peerId) return alert("Select a peer first");

                try {
                    const sdp = await manager.create_offer(peerId);
                    document.getElementById('local-sdp').value = sdp;
                    logSystem(`Created offer for ${peerId}`);
                } catch (e) {
                    alert("Error: " + e);
                }
            };

            // Join (Create Answer)
            document.getElementById('btn-join').onclick = async () => {
                const peerId = document.getElementById('conn-peer-select').value;
                if (!peerId) return alert("Select a peer first");
                const remoteSdp = document.getElementById('remote-sdp').value;
                if (!remoteSdp) return alert("Paste Remote SDP");

                try {
                    const sdp = await manager.create_answer(peerId, remoteSdp);
                    document.getElementById('local-sdp').value = sdp;
                    logSystem(`Created answer for ${peerId}`);
                } catch (e) {
                    alert("Error: " + e);
                }
            };

            // Receive Answer
            document.getElementById('btn-receive-answer').onclick = async () => {
                const peerId = document.getElementById('conn-peer-select').value;
                if (!peerId) return alert("Select a peer first");
                const remoteSdp = document.getElementById('remote-sdp').value;
                if (!remoteSdp) return alert("Paste Remote SDP");

                try {
                    await manager.receive_answer(peerId, remoteSdp);
                    logSystem(`Received answer from ${peerId}`);
                } catch (e) {
                    alert("Error: " + e);
                }
            };

            // Add Candidates
            document.getElementById('btn-add-candidates').onclick = async () => {
                const peerId = document.getElementById('ice-peer-select').value;
                if (!peerId) return alert("Select a peer first");
                const json = document.getElementById('remote-candidates').value;
                if (!json) return;

                try {
                    const candidates = JSON.parse(json);
                    if (Array.isArray(candidates)) {
                        for (const c of candidates) {
                            await manager.add_ice_candidate(peerId, JSON.stringify(c));
                        }
                        logSystem(`Added ${candidates.length} candidates for ${peerId}`);
                        alert("Candidates added!");
                    }
                } catch (e) {
                    alert("Error: " + e);
                }
            };

            // Send Message
            document.getElementById('btn-send').onclick = sendMessage;
            document.getElementById('msg-input').onkeypress = (e) => {
                if (e.key === 'Enter') sendMessage();
            };

            // Update candidates UI when selection changes
            document.getElementById('ice-peer-select').onchange = (e) => {
                updateLocalCandidatesUI(e.target.value);
                document.getElementById('remote-candidates').value = "";
            };

            // Clear SDPs when connection peer changes
            document.getElementById('conn-peer-select').onchange = () => {
                document.getElementById('local-sdp').value = "";
                document.getElementById('remote-sdp').value = "";
            };
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const msg = input.value;
            if (!msg) return;

            const target = document.getElementById('chat-peer-select').value;

            try {
                if (target === 'broadcast') {
                    manager.broadcast_message(msg);
                    logMessage("Me (All)", msg, "my-message");
                } else {
                    manager.send_message(target, msg);
                    logMessage(`Me -> ${target}`, msg, "my-message");
                }
                input.value = "";
            } catch (e) {
                console.error(e);
                alert("Error sending: " + e);
            }
        }

        function addPeerToUI(id) {
            const list = document.getElementById('peers-list');
            if (list.children.length === 1 && list.children[0].textContent === "No peers added yet.") {
                list.innerHTML = "";
            }

            const div = document.createElement('div');
            div.className = "peer-item";
            div.id = `peer-item-${id}`;
            div.innerHTML = `
                <span><strong>${id}</strong></span>
                <span class="peer-status" id="status-${id}">New</span>
            `;
            list.appendChild(div);
        }

        function updatePeerStatus(id, status) {
            const el = document.getElementById(`status-${id}`);
            if (el) {
                el.textContent = status;
                if (status === 'connected') el.style.background = '#d4edda';
                else if (status === 'disconnected' || status === 'failed') el.style.background = '#f8d7da';
                else el.style.background = '#eee';
            }
        }

        function updateSelects() {
            const connSel = document.getElementById('conn-peer-select');
            const iceSel = document.getElementById('ice-peer-select');
            const chatSel = document.getElementById('chat-peer-select');

            // Save current selections
            const currConn = connSel.value;
            const currIce = iceSel.value;
            const currChat = chatSel.value;

            // Clear options (keep headers)
            connSel.innerHTML = '<option value="">-- Select Peer --</option>';
            iceSel.innerHTML = '<option value="">-- Select Peer --</option>';
            chatSel.innerHTML = '<option value="broadcast">Broadcast (All)</option>';

            peers.forEach(id => {
                connSel.add(new Option(id, id));
                iceSel.add(new Option(id, id));
                chatSel.add(new Option(id, id));
            });

            // Restore selections if valid
            if (peers.has(currConn)) connSel.value = currConn;
            if (peers.has(currIce)) iceSel.value = currIce;
            if (peers.has(currChat) || currChat === 'broadcast') chatSel.value = currChat;
        }

        function updateLocalCandidatesUI(peerId) {
            const textarea = document.getElementById('local-candidates');
            if (!peerId || !localCandidatesMap.has(peerId)) {
                textarea.value = "[]";
                return;
            }
            const candidates = localCandidatesMap.get(peerId);
            textarea.value = JSON.stringify(candidates, null, 2);
        }

        function logMessage(sender, text, className) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = "message " + className;
            div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function logSystem(text) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = "message system-message";
            div.textContent = text;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        run();
    </script>
</body>

</html>